{
	"info": {
		"_postman_id": "e6463d6c-1e03-4134-af28-51bd4e10b847",
		"name": "KTC Email & Invoice Test Collection (Updated)",
		"description": "Collection test chá»©c nÄƒng táº¡o file PDF hÃ³a Ä‘Æ¡n, download PDF vÃ  gá»­i email tá»± Ä‘á»™ng cá»§a há»‡ thá»‘ng KTC Logistics\n\nðŸŽ¯ **WORKFLOW HOÃ€N CHá»ˆNH:**\n1. Login â†’ 2. Táº¡o hÃ³a Ä‘Æ¡n (tá»± Ä‘á»™ng táº¡o PDF) â†’ 3. Download PDF â†’ 4. Gá»­i email\n\nðŸ†• **Cáº¬P NHáº¬T Má»šI (2025-08-24):**\n- HÃ³a Ä‘Æ¡n hiá»‡n bao gá»“m **MÃƒ Váº¬N ÄÆ N** (delivery.id)\n- Tá»•ng giÃ¡ trá»‹ Ä‘Æ¡n hÃ ng Ä‘Æ°á»£c láº¥y tá»« **DELIVERY_FEE** thay vÃ¬ total_amount\n- PDF tháº­t sá»± thay vÃ¬ HTML format\n- Quan há»‡ ElectronicInvoice â†’ Delivery Ä‘Ã£ Ä‘Æ°á»£c thÃªm\n\nðŸ“¥ **DOWNLOAD PDF:**\n- API: GET /api/invoices/{id}/download-pdf\n- File tá»± Ä‘á»™ng táº£i vá» vá»›i tÃªn: HoaDon_{InvoiceNumber}.pdf\n- Content-Type: application/pdf (PDF tháº­t sá»±)\n- Chá»‰ cáº§n JWT token, khÃ´ng cáº§n generate-pdf riÃªng\n\nðŸ”— **YÃŠU Cáº¦U DELIVERY:**\n- Má»—i order pháº£i cÃ³ delivery tÆ°Æ¡ng á»©ng\n- Delivery pháº£i cÃ³ delivery_fee > 0\n- HÃ³a Ä‘Æ¡n sáº½ hiá»ƒn thá»‹: delivery.id vÃ  delivery.delivery_fee\n\nðŸš¨ **QUAN TRá»ŒNG - GIáº¢I QUYáº¾T Lá»–I AUTHENTICATION:**\n\nNáº¿u gáº·p lá»—i \"User not found with email: admin\", thá»±c hiá»‡n theo thá»© tá»±:\n\n1ï¸âƒ£ **Kiá»ƒm tra User trong Database:**\n   - Äáº£m báº£o cÃ³ user vá»›i email: datkz31@gmail.com\n   - Kiá»ƒm tra field 'username' cá»§a user nÃ y\n   - Kiá»ƒm tra 'role_id' pháº£i lÃ  role ADMIN\n\n2ï¸âƒ£ **Kiá»ƒm tra Delivery Data:**\n   - Äáº£m báº£o cÃ³ delivery records cho test order\n   - Kiá»ƒm tra delivery.delivery_fee > 0\n   - Kiá»ƒm tra delivery.order_id matching\n\n3ï¸âƒ£ **Cáº­p nháº­t Environment Variables:**\n   - adminEmail: email tháº­t trong database\n   - adminUsername: username tháº­t trong database  \n   - adminPassword: password tháº­t\n   - testEmail: email Ä‘á»ƒ nháº­n test invoice\n   - testOrderId: order cÃ³ delivery data\n\n4ï¸âƒ£ **Test Authentication:**\n   - Cháº¡y \"Login Admin (Email)\" trÆ°á»›c\n   - Náº¿u tháº¥t báº¡i, cháº¡y \"Login Admin (Username - Backup)\"\n   - Kiá»ƒm tra Console log Ä‘á»ƒ debug",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
		"_exporter_id": "33340750"
	},
	"item": [
		{
			"name": "Authentication",
			"item": [
				{
					"name": "Login Admin (Email)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// LÆ°u token vÃ o environment variable",
									"if (pm.response.code === 200) {",
									"    const responseJson = pm.response.json();",
									"    if (responseJson.token) {",
									"        pm.environment.set('authToken', responseJson.token);",
									"        console.log('âœ… Login thÃ nh cÃ´ng! Token Ä‘Ã£ Ä‘Æ°á»£c lÆ°u: ' + responseJson.token.substring(0, 20) + '...');",
									"        if (responseJson.user) {",
									"            console.log('ðŸ‘¤ User: ' + responseJson.user.fullName + ' (' + responseJson.user.role + ')');",
									"        }",
									"    }",
									"    pm.test('ÄÄƒng nháº­p thÃ nh cÃ´ng', function () {",
									"        pm.response.to.have.status(200);",
									"    });",
									"} else {",
									"    const responseJson = pm.response.json();",
									"    console.log('âŒ Login tháº¥t báº¡i: ' + (responseJson.message || 'Unknown error'));",
									"    pm.test('ÄÄƒng nháº­p tháº¥t báº¡i', function () {",
									"        pm.response.to.not.have.status(200);",
									"    });",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"email\": \"{{adminEmail}}\",\n    \"password\": \"{{adminPassword}}\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/api/auth/login",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"auth",
								"login"
							]
						},
						"description": "ÄÄƒng nháº­p vá»›i email admin. Há»‡ thá»‘ng tÃ¬m user theo email vÃ  authenticate báº±ng username tÆ°Æ¡ng á»©ng."
					},
					"response": []
				},
				{
					"name": "Login Admin (Username - Backup)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// Alternative login náº¿u email login khÃ´ng hoáº¡t Ä‘á»™ng",
									"if (pm.response.code === 200) {",
									"    const responseJson = pm.response.json();",
									"    if (responseJson.token) {",
									"        pm.environment.set('authToken', responseJson.token);",
									"        console.log('âœ… Username login thÃ nh cÃ´ng! Token: ' + responseJson.token.substring(0, 20) + '...');",
									"    }",
									"    pm.test('Username login thÃ nh cÃ´ng', function () {",
									"        pm.response.to.have.status(200);",
									"    });",
									"} else {",
									"    console.log('âŒ Username login cÅ©ng tháº¥t báº¡i');",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"email\": \"{{adminUsername}}\",\n    \"password\": \"{{adminPassword}}\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/api/auth/login",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"auth",
								"login"
							]
						},
						"description": "Backup login vá»›i username thay vÃ¬ email, trong trÆ°á»ng há»£p username khÃ¡c vá»›i email trong database."
					},
					"response": []
				}
			],
			"description": "CÃ¡c API xÃ¡c thá»±c ngÆ°á»i dÃ¹ng"
		},
		{
			"name": "Data Validation",
			"item": [
				{
					"name": "Check Delivery Data for Order",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Check delivery data successful', function () {",
									"    // CÃ³ thá»ƒ tráº£ vá» 200 (cÃ³ delivery) hoáº·c 404 (khÃ´ng cÃ³ delivery)",
									"    if (pm.response.code === 200) {",
									"        const responseJson = pm.response.json();",
									"        console.log('âœ… Delivery found for order: ' + pm.environment.get('testOrderId'));",
									"        if (responseJson.data && responseJson.data.length > 0) {",
									"            const delivery = responseJson.data[0];",
									"            console.log('ðŸ“¦ Delivery ID: ' + delivery.id);",
									"            console.log('ðŸ’° Delivery Fee: ' + delivery.deliveryFee);",
									"            pm.environment.set('testDeliveryId', delivery.id);",
									"            pm.environment.set('testDeliveryFee', delivery.deliveryFee);",
									"        }",
									"    } else {",
									"        console.log('âš ï¸ No delivery found for order: ' + pm.environment.get('testOrderId'));",
									"        console.log('ðŸ’¡ Suggestion: Create delivery data or use different testOrderId');",
									"    }",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{authToken}}"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/api/deliveries?orderId={{testOrderId}}",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"deliveries"
							],
							"query": [
								{
									"key": "orderId",
									"value": "{{testOrderId}}"
								}
							]
						},
						"description": "ðŸ†• Kiá»ƒm tra dá»¯ liá»‡u delivery cho order test. Cáº§n cÃ³ delivery vá»›i delivery_fee > 0 Ä‘á»ƒ táº¡o hÃ³a Ä‘Æ¡n."
					},
					"response": []
				}
			],
			"description": "ðŸ†• Kiá»ƒm tra dá»¯ liá»‡u cáº§n thiáº¿t cho tÃ­nh nÄƒng má»›i"
		},
		{
			"name": "Email Testing",
			"item": [
				{
					"name": "Check Email Service Status",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Email service status check successful', function () {",
									"    pm.response.to.have.status(200);",
									"    const responseJson = pm.response.json();",
									"    pm.expect(responseJson.success).to.be.true;",
									"    pm.expect(responseJson.data).to.have.property('available');",
									"    console.log('Email service available: ' + responseJson.data.available);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{authToken}}"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/api/test/email/status",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"test",
								"email",
								"status"
							]
						},
						"description": "Kiá»ƒm tra tráº¡ng thÃ¡i hoáº¡t Ä‘á»™ng cá»§a dá»‹ch vá»¥ email"
					},
					"response": []
				},
				{
					"name": "Send Test Email",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Test email sent successfully', function () {",
									"    pm.response.to.have.status(200);",
									"    const responseJson = pm.response.json();",
									"    pm.expect(responseJson.success).to.be.true;",
									"    console.log('Test email response: ' + responseJson.message);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{authToken}}"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/api/test/email/send-test?email={{testEmail}}",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"test",
								"email",
								"send-test"
							],
							"query": [
								{
									"key": "email",
									"value": "{{testEmail}}"
								}
							]
						},
						"description": "Gá»­i email test Ä‘áº¿n Ä‘á»‹a chá»‰ Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh Ä‘á»ƒ kiá»ƒm tra cáº¥u hÃ¬nh email"
					},
					"response": []
				}
			],
			"description": "Test cÃ¡c chá»©c nÄƒng email cÆ¡ báº£n"
		},
		{
			"name": "Invoice Management",
			"item": [
				{
					"name": "Get Orders Needing Invoice",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Get orders needing invoice successful', function () {",
									"    pm.response.to.have.status(200);",
									"    const responseJson = pm.response.json();",
									"    pm.expect(responseJson.success).to.be.true;",
									"    if (responseJson.data && responseJson.data.length > 0) {",
									"        // LÆ°u order ID Ä‘áº§u tiÃªn Ä‘á»ƒ sá»­ dá»¥ng cho test tiáº¿p theo",
									"        pm.environment.set('testOrderId', responseJson.data[0].id);",
									"        console.log('Found orders needing invoice: ' + responseJson.data.length);",
									"        console.log('Test order ID: ' + responseJson.data[0].id);",
									"    } else {",
									"        console.log('No orders need invoice currently');",
									"        // Set má»™t order ID máº·c Ä‘á»‹nh Ä‘á»ƒ test",
									"        pm.environment.set('testOrderId', 1);",
									"    }",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{authToken}}"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/api/invoices/orders-needing-invoice",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"invoices",
								"orders-needing-invoice"
							]
						},
						"description": "Láº¥y danh sÃ¡ch cÃ¡c Ä‘Æ¡n hÃ ng cáº§n xuáº¥t hÃ³a Ä‘Æ¡n"
					},
					"response": []
				},
				{
					"name": "Check Invoice Eligibility",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Check invoice eligibility successful', function () {",
									"    pm.response.to.have.status(200);",
									"    const responseJson = pm.response.json();",
									"    pm.expect(responseJson.success).to.be.true;",
									"    pm.expect(responseJson.data).to.have.property('eligible');",
									"    pm.expect(responseJson.data).to.have.property('message');",
									"    console.log('Order eligible for invoice: ' + responseJson.data.eligible);",
									"    console.log('Message: ' + responseJson.data.message);",
									"    ",
									"    // ðŸ†• Cáº£nh bÃ¡o náº¿u khÃ´ng cÃ³ delivery data",
									"    if (!responseJson.data.eligible && responseJson.data.message.includes('delivery')) {",
									"        console.log('âš ï¸ WARNING: Order cáº§n cÃ³ delivery data vá»›i delivery_fee > 0');",
									"    }",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{authToken}}"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/api/invoices/check-eligibility/{{testOrderId}}",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"invoices",
								"check-eligibility",
								"{{testOrderId}}"
							]
						},
						"description": "Kiá»ƒm tra Ä‘iá»u kiá»‡n xuáº¥t hÃ³a Ä‘Æ¡n cho má»™t Ä‘Æ¡n hÃ ng cá»¥ thá»ƒ. ðŸ†• Giá» bao gá»“m kiá»ƒm tra delivery data."
					},
					"response": []
				},
				{
					"name": "Create Invoice",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Create invoice successful', function () {",
									"    pm.response.to.have.status(201);",
									"    const responseJson = pm.response.json();",
									"    pm.expect(responseJson.success).to.be.true;",
									"    if (responseJson.data && responseJson.data.id) {",
									"        pm.environment.set('createdInvoiceId', responseJson.data.id);",
									"        console.log('âœ… Created invoice ID: ' + responseJson.data.id);",
									"        console.log('ðŸ“„ Invoice number: ' + responseJson.data.invoiceNumber);",
									"        ",
									"        // ðŸ†• Kiá»ƒm tra thÃ´ng tin má»›i",
									"        if (responseJson.data.deliveryId) {",
									"            console.log('ðŸšš Delivery ID: ' + responseJson.data.deliveryId);",
									"        }",
									"        if (responseJson.data.totalAmount) {",
									"            console.log('ðŸ’° Total Amount (from delivery_fee): ' + responseJson.data.totalAmount);",
									"        }",
									"        console.log('ðŸ“ PDF Path: ' + responseJson.data.pdfFilePath);",
									"    }",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{authToken}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"orderId\": {{testOrderId}},\n    \"customerEmail\": \"{{testEmail}}\",\n    \"customerName\": \"Nguyá»…n VÄƒn Test (Updated)\",\n    \"notes\": \"HÃ³a Ä‘Æ¡n test vá»›i mÃ£ váº­n Ä‘Æ¡n vÃ  delivery fee - Created from Postman collection\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/api/invoices",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"invoices"
							]
						},
						"description": "ðŸ†• Táº¡o hÃ³a Ä‘Æ¡n thanh toÃ¡n má»›i (tá»± Ä‘á»™ng táº¡o PDF tháº­t sá»±). Giá» sá»­ dá»¥ng delivery_fee vÃ  hiá»ƒn thá»‹ delivery.id."
					},
					"response": []
				},
				{
					"name": "Generate PDF for Invoice",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Generate PDF successful', function () {",
									"    pm.response.to.have.status(200);",
									"    const responseJson = pm.response.json();",
									"    pm.expect(responseJson.success).to.be.true;",
									"    if (responseJson.data) {",
									"        console.log('âœ… PDF generated at: ' + responseJson.data);",
									"        console.log('ðŸ“„ Format: Tháº­t sá»± PDF, khÃ´ng pháº£i HTML');",
									"    }",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{authToken}}"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/api/invoices/{{createdInvoiceId}}/generate-pdf",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"invoices",
								"{{createdInvoiceId}}",
								"generate-pdf"
							]
						},
						"description": "ðŸ”„ Táº¡o file PDF cho hÃ³a Ä‘Æ¡n Ä‘Ã£ táº¡o (thÆ°á»ng khÃ´ng cáº§n vÃ¬ tá»± Ä‘á»™ng táº¡o khi create)"
					},
					"response": []
				},
				{
					"name": "Send Invoice by Email",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Send invoice by email successful', function () {",
									"    pm.response.to.have.status(200);",
									"    const responseJson = pm.response.json();",
									"    pm.expect(responseJson.success).to.be.true;",
									"    console.log('âœ… Email sent successfully: ' + responseJson.message);",
									"    console.log('ðŸ“§ Check email for PDF attachment (real PDF format)');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{authToken}}"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/api/invoices/{{createdInvoiceId}}/send-email?emailAddress={{testEmail}}",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"invoices",
								"{{createdInvoiceId}}",
								"send-email"
							],
							"query": [
								{
									"key": "emailAddress",
									"value": "{{testEmail}}"
								}
							]
						},
						"description": "ðŸ“§ Gá»­i hÃ³a Ä‘Æ¡n qua email kÃ¨m file PDF attachment (PDF tháº­t sá»±)"
					},
					"response": []
				},
				{
					"name": "Get Invoice Details",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Get invoice details successful', function () {",
									"    pm.response.to.have.status(200);",
									"    const responseJson = pm.response.json();",
									"    pm.expect(responseJson.success).to.be.true;",
									"    pm.expect(responseJson.data).to.have.property('id');",
									"    pm.expect(responseJson.data).to.have.property('invoiceNumber');",
									"    pm.expect(responseJson.data).to.have.property('status');",
									"    console.log('ðŸ“„ Invoice status: ' + responseJson.data.status);",
									"    console.log('ðŸ’° Invoice amount: ' + responseJson.data.totalAmount);",
									"    ",
									"    // ðŸ†• Kiá»ƒm tra thÃ´ng tin delivery",
									"    if (responseJson.data.deliveryId) {",
									"        console.log('ðŸšš Delivery ID: ' + responseJson.data.deliveryId);",
									"    }",
									"    if (responseJson.data.pdfFilePath) {",
									"        console.log('ðŸ“ PDF available at: ' + responseJson.data.pdfFilePath);",
									"    }",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{authToken}}"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/api/invoices/{{createdInvoiceId}}",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"invoices",
								"{{createdInvoiceId}}"
							]
						},
						"description": "ðŸ“‹ Láº¥y chi tiáº¿t hÃ³a Ä‘Æ¡n Ä‘á»ƒ kiá»ƒm tra thÃ´ng tin sau khi gá»­i email"
					},
					"response": []
				},
				{
					"name": "Download Invoice PDF",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('PDF download successful', function () {",
									"    pm.response.to.have.status(200);",
									"    pm.expect(pm.response.headers.get('Content-Type')).to.include('application/pdf');",
									"    pm.expect(pm.response.headers.get('Content-Disposition')).to.include('attachment');",
									"    console.log('âœ… PDF download thÃ nh cÃ´ng! (Äá»‹nh dáº¡ng PDF tháº­t sá»±)');",
									"});",
									"",
									"// Log thÃ´ng tin file",
									"const contentLength = pm.response.headers.get('Content-Length');",
									"const fileName = pm.response.headers.get('Content-Disposition');",
									"console.log('ðŸ“ File size: ' + contentLength + ' bytes');",
									"console.log('ðŸ“„ File name: ' + fileName);",
									"",
									"// ðŸ†• Kiá»ƒm tra format PDF tháº­t sá»±",
									"pm.test('File is real PDF format', function () {",
									"    const contentType = pm.response.headers.get('Content-Type');",
									"    pm.expect(contentType).to.equal('application/pdf');",
									"    console.log('âœ… Confirmed: Real PDF format, not HTML');",
									"});"
								],
								"type": "text/javascript",
								"packages": {}
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{authToken}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{authToken}}"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/api/invoices/{{createdInvoiceId}}/download-pdf",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"invoices",
								"{{createdInvoiceId}}",
								"download-pdf"
							]
						},
						"description": "ðŸ“¥ Download file PDF cá»§a hÃ³a Ä‘Æ¡n thanh toÃ¡n. ðŸ†• File sáº½ lÃ  PDF tháº­t sá»± vá»›i mÃ£ váº­n Ä‘Æ¡n."
					},
					"response": []
				},
				{
					"name": "Get All Invoices",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Get all invoices successful', function () {",
									"    pm.response.to.have.status(200);",
									"    const responseJson = pm.response.json();",
									"    pm.expect(responseJson.success).to.be.true;",
									"    console.log('Total invoices found: ' + (responseJson.data ? responseJson.data.length : 0));",
									"    ",
									"    // ðŸ†• Kiá»ƒm tra invoice cÃ³ delivery info",
									"    if (responseJson.data && responseJson.data.length > 0) {",
									"        const latestInvoice = responseJson.data[0];",
									"        if (latestInvoice.deliveryId) {",
									"            console.log('âœ… Latest invoice has delivery ID: ' + latestInvoice.deliveryId);",
									"        }",
									"    }",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{authToken}}"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/api/invoices",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"invoices"
							]
						},
						"description": "ðŸ“‹ Láº¥y danh sÃ¡ch táº¥t cáº£ hÃ³a Ä‘Æ¡n Ä‘á»ƒ xem káº¿t quáº£ test"
					},
					"response": []
				}
			],
			"description": "ðŸ”„ Test cÃ¡c chá»©c nÄƒng quáº£n lÃ½ hÃ³a Ä‘Æ¡n vá»›i cáº­p nháº­t má»›i (delivery integration)"
		},
		{
			"name": "Complete Email & PDF Test Flow",
			"item": [
				{
					"name": "End-to-End Test: Create + Generate PDF + Send Email",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"// Thiáº¿t láº­p dá»¯ liá»‡u test",
									"const timestamp = new Date().getTime();",
									"pm.environment.set('testCustomerName', 'KTC Test Customer ' + timestamp);",
									"pm.environment.set('testNotes', 'E2E test vá»›i delivery integration - Created at ' + new Date().toISOString());",
									"console.log('ðŸš€ Preparing E2E test with delivery integration');",
									"console.log('ðŸ“… Timestamp: ' + timestamp);"
								],
								"type": "text/javascript",
								"packages": {}
							}
						},
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('End-to-end test successful', function () {",
									"    pm.response.to.have.status(201);",
									"    const responseJson = pm.response.json();",
									"    pm.expect(responseJson.success).to.be.true;",
									"    ",
									"    if (responseJson.data && responseJson.data.id) {",
									"        pm.environment.set('e2eInvoiceId', responseJson.data.id);",
									"        console.log('âœ… E2E Test: Invoice created with ID ' + responseJson.data.id);",
									"        console.log('ðŸšš E2E Test: Delivery ID ' + responseJson.data.deliveryId);",
									"        console.log('ðŸ’° E2E Test: Amount from delivery_fee ' + responseJson.data.totalAmount);",
									"        console.log('ðŸ“„ E2E Test: PDF auto-generated (real PDF format)');",
									"        console.log('âœ… E2E Test: Ready for email sending');",
									"        ",
									"        // Tá»± Ä‘á»™ng cháº¡y send email test",
									"        setTimeout(() => {",
									"            pm.sendRequest({",
									"                url: pm.environment.get('baseUrl') + '/api/invoices/' + responseJson.data.id + '/send-email?emailAddress=' + pm.environment.get('testEmail'),",
									"                method: 'POST',",
									"                header: {",
									"                    'Authorization': 'Bearer ' + pm.environment.get('authToken')",
									"                }",
									"            }, (err, res) => {",
									"                if (err) {",
									"                    console.log('âŒ E2E Test: Email sending failed - ' + err);",
									"                } else if (res.code === 200) {",
									"                    console.log('âœ… E2E Test: Email sent successfully!');",
									"                    console.log('ðŸ“§ E2E Test: Check email for real PDF invoice with delivery info');",
									"                } else {",
									"                    console.log('âŒ E2E Test: Email sending failed with status ' + res.code);",
									"                }",
									"            });",
									"        }, 2000); // Äá»£i 2 giÃ¢y Ä‘á»ƒ PDF Ä‘Æ°á»£c táº¡o xong",
									"    } else {",
									"        console.log('âŒ E2E Test: Failed to create invoice - check delivery data');",
									"    }",
									"});"
								],
								"type": "text/javascript",
								"packages": {}
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{authToken}}",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{authToken}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"orderId\": {{testOrderId}},\n    \"customerEmail\": \"{{testEmail}}\",\n    \"customerName\": \"{{testCustomerName}}\",\n    \"notes\": \"{{testNotes}}\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/api/invoices",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"invoices"
							]
						},
						"description": "ðŸŽ¯ Test toÃ n bá»™ quy trÃ¬nh: Táº¡o hÃ³a Ä‘Æ¡n (vá»›i delivery integration) â†’ Táº¡o PDF tháº­t sá»± â†’ Gá»­i email"
					},
					"response": []
				}
			],
			"description": "ðŸ”„ Test quy trÃ¬nh hoÃ n chá»‰nh vá»›i cáº­p nháº­t má»›i (delivery integration & real PDF)"
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Global pre-request script",
					"console.log('ðŸš€ Starting API test for: ' + pm.info.requestName);",
					"console.log('ðŸ“ Environment: ' + pm.environment.name);",
					"console.log('ðŸ”— Base URL: ' + pm.environment.get('baseUrl'));",
					"console.log('ðŸ†• Updated collection with delivery integration');"
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Global test script",
					"console.log('ðŸ“Š Response status: ' + pm.response.code);",
					"console.log('â±ï¸ Response time: ' + pm.response.responseTime + 'ms');",
					"",
					"// Check for common error patterns",
					"if (pm.response.code >= 400) {",
					"    console.log('âŒ Error response received');",
					"    try {",
					"        const errorResponse = pm.response.json();",
					"        if (errorResponse.message) {",
					"            console.log('Error message: ' + errorResponse.message);",
					"            // ðŸ†• Specific check for delivery-related errors",
					"            if (errorResponse.message.includes('delivery') || errorResponse.message.includes('Delivery')) {",
					"                console.log('âš ï¸ DELIVERY ERROR: Ensure order has delivery data with delivery_fee > 0');",
					"            }",
					"        }",
					"    } catch (e) {",
					"        console.log('Could not parse error response as JSON');",
					"    }",
					"}"
				]
			}
		}
	],
	"variable": [
		{
			"key": "baseUrl",
			"value": "http://localhost:8080",
			"type": "string"
		},
		{
			"key": "adminEmail",
			"value": "datkz31@gmail.com",
			"type": "string"
		},
		{
			"key": "adminUsername",
			"value": "datkz31@gmail.com",
			"type": "string"
		},
		{
			"key": "adminPassword",
			"value": "123123",
			"type": "string"
		},
		{
			"key": "testEmail",
			"value": "datkz31@gmail.com",
			"type": "string"
		},
		{
			"key": "authToken",
			"value": "",
			"type": "string"
		},
		{
			"key": "testOrderId",
			"value": "1",
			"type": "string",
			"description": "ðŸ†• Order ID pháº£i cÃ³ delivery data tÆ°Æ¡ng á»©ng"
		},
		{
			"key": "createdInvoiceId",
			"value": "",
			"type": "string"
		},
		{
			"key": "e2eInvoiceId",
			"value": "",
			"type": "string"
		},
		{
			"key": "testCustomerName",
			"value": "",
			"type": "string"
		},
		{
			"key": "testNotes",
			"value": "",
			"type": "string"
		},
		{
			"key": "testDeliveryId",
			"value": "",
			"type": "string",
			"description": "ðŸ†• Delivery ID Ä‘Æ°á»£c láº¥y tá»« API response"
		},
		{
			"key": "testDeliveryFee",
			"value": "",
			"type": "string",
			"description": "ðŸ†• Delivery fee Ä‘Æ°á»£c láº¥y tá»« API response"
		}
	]
}
